# Production Deployment Workflow
# Prevents Error #8 (context syntax), #6 (secrets)
#
# Triggers on: push to main (after tests pass)
# Deploys to: Production environment
# Requires: deployment secrets configured

name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build production bundle
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: production-build
          path: dist/
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-24.04
    environment:
      name: production
      url: https://your-app.com

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: production-build
          path: dist/

      - name: Deploy to production
        run: |
          echo "Deploying to production..."
          # Add your deployment command here
          # Examples:
          # npx wrangler deploy --env production
          # aws s3 sync dist/ s3://your-bucket/
          # vercel deploy --prod
        env:
          # Add your deployment secrets
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          # CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "Environment: production"
          echo "Commit: ${{ github.sha }}"
          echo "URL: https://your-app.com"
