#!/usr/bin/env bash
#
# Pre-commit hook for claude-skills repository
#
# Validates JSON files (marketplace.json and plugin.json) before commit
# Only validates CHANGED files for performance
#
# Setup (one-time):
#   npm install -g ajv-cli ajv-formats
#   git config core.hooksPath .githooks
#
# Bypass (when necessary):
#   git commit --no-verify

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo "üîç Running JSON schema validation..."

# Check if ajv-cli is installed
if ! command -v ajv &> /dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  Warning: ajv-cli not installed${NC}"
  echo ""
  echo "JSON schema validation is disabled."
  echo "To enable, install ajv-cli:"
  echo "  npm install -g ajv-cli ajv-formats"
  echo ""
  echo "Proceeding with commit..."
  exit 0
fi

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
SCHEMAS_DIR="$REPO_ROOT/schemas"

# Get staged JSON files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.json$' || true)

if [ -z "$CHANGED_FILES" ]; then
  echo "No JSON files changed"
  echo ""
  exit 0
fi

validation_failed=0

# Check marketplace.json
if echo "$CHANGED_FILES" | grep -q "marketplace.json"; then
  echo ""
  echo -e "${BLUE}üì¶ Validating marketplace.json...${NC}"

  if ajv validate \
    -s "$SCHEMAS_DIR/marketplace.schema.json" \
    -d "$REPO_ROOT/.claude-plugin/marketplace.json" \
    --spec=draft7 \
    --strict=false \
    --all-errors 2>&1; then
    echo -e "${GREEN}‚úÖ marketplace.json is valid${NC}"
  else
    echo -e "${RED}‚ùå marketplace.json validation FAILED${NC}"
    validation_failed=1
  fi
fi

# Check plugin.json files
CHANGED_PLUGINS=$(echo "$CHANGED_FILES" | grep "plugin.json" || true)

if [ -n "$CHANGED_PLUGINS" ]; then
  echo ""
  echo -e "${BLUE}üîå Validating plugin.json files...${NC}"

  while IFS= read -r plugin_file; do
    if [ -z "$plugin_file" ]; then continue; fi

    plugin_name=$(basename "$(dirname "$(dirname "$plugin_file")")")

    # Run validation and capture output
    # Temporarily disable errexit to capture exit code
    set +e
    validation_output=$(ajv validate \
      -s "$SCHEMAS_DIR/plugin.schema.json" \
      -d "$REPO_ROOT/$plugin_file" \
      --spec=draft7 \
      --strict=false \
      --all-errors 2>&1)
    validation_exit_code=$?
    set -e

    # Check exit code, not output content
    if [ $validation_exit_code -eq 0 ]; then
      echo -e "${GREEN}‚úÖ${NC} $plugin_name"
    else
      echo -e "${RED}‚ùå${NC} $plugin_name - VALIDATION FAILED"
      echo ""
      echo "Details:"
      echo "$validation_output"
      echo ""
      validation_failed=1
    fi
  done <<< "$CHANGED_PLUGINS"
fi

echo ""

if [ $validation_failed -eq 1 ]; then
  echo -e "${RED}‚ùå Validation failed${NC}"
  echo ""
  echo "Fix the errors above, or bypass with:"
  echo -e "  ${YELLOW}git commit --no-verify${NC}"
  echo ""
  exit 1
else
  echo -e "${GREEN}‚úÖ All validations passed${NC}"
  echo ""
  exit 0
fi
